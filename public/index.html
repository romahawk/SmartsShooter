<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   SmartShooter
  </title>
  <script src="https://cdn.tailwindcss.com">
  </script>
 </head>
 <body class="bg-gray-100 text-gray-800 font-sans p-4 overflow-x-hidden">
  <!-- ğŸ§± GRID: 2 rows Ã— 2 columns -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full max-w-screen-2xl mx-auto mt-8 px-4">
   <!-- ğŸ“Š Left: SmartShooter Training Log (Form) -->
   <div class="bg-white p-6 rounded-xl shadow-md flex flex-col w-full">
    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
     ğŸ“Š SmartShooter Training Log
    </h2>
    <!-- Include your actual logForm here -->
    <form class="space-y-6" id="logForm">
     <input id="sessionId" type="hidden"/>
     <!-- Row: Date, Training Type, Rounds, Zone Type -->
     <div class="flex flex-wrap md:flex-nowrap gap-4">
      <!-- Date -->
      <div class="flex-1 min-w-[150px]">
       <label class="block text-sm font-medium text-gray-700 flex items-center gap-1" for="date">
        <!-- Calendar icon -->
        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24">
         <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round">
         </path>
        </svg>
        Date
       </label>
       <input class="w-full mt-1 border border-gray-300 p-2 rounded" id="date" required="" type="date"/>
      </div>
      <!-- Training Type -->
      <div class="flex-1 min-w-[180px]">
       <label class="block text-sm font-medium text-gray-700 flex items-center gap-1" for="trainingType">
        <!-- Clipboard icon -->
        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24">
         <path d="M9 2h6a2 2 0 012 2v1H7V4a2 2 0 012-2zM7 7h10v13a2 2 0 01-2 2H9a2 2 0 01-2-2V7z" stroke-linecap="round" stroke-linejoin="round">
         </path>
        </svg>
        Training Type
       </label>
       <select class="w-full mt-1 border border-gray-300 p-2 rounded" id="trainingType" required="">
        <option value="">
         -- Select Training Type --
        </option>
        <option value="Spot Shooting">
         Spot Shooting
        </option>
        <option value="Catch and Shoot">
         Catch and Shoot
        </option>
        <option value="Off the Dribble">
         Off the Dribble
        </option>
        <option value="Run Half Court">
         Run Half Court
        </option>
       </select>
      </div>
      <!-- Rounds -->
      <div class="flex-1 min-w-[100px]">
       <label class="block text-sm font-medium text-gray-700 flex items-center gap-1" for="roundCount">
        <!-- Repeat icon -->
        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24">
         <path d="M4 4v6h6M20 20v-6h-6M4 10a9 9 0 0115.3-5.3L20 4M20 14a9 9 0 01-15.3 5.3L4 20" stroke-linecap="round" stroke-linejoin="round">
         </path>
        </svg>
        Rounds
       </label>
       <input class="w-full mt-1 border border-gray-300 p-2 rounded" id="roundCount" max="10" min="1" required="" type="number" value="1"/>
      </div>
      <!-- Zone Type -->
      <div class="flex-1 min-w-[160px]">
       <label class="block text-sm font-medium text-gray-700 flex items-center gap-1" for="zoneType">
        <!-- Location marker icon -->
        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24">
         <path d="M12 11c1.1046 0 2-.8954 2-2s-.8954-2-2-2-2 .8954-2 2 .8954 2 2 2zm0 0c-2.5 0-5 2.239-5 5.5C7 19.985 12 22 12 22s5-2.015 5-5.5c0-3.261-2.5-5.5-5-5.5z" stroke-linecap="round" stroke-linejoin="round">
         </path>
        </svg>
        Zone Type
       </label>
       <select class="w-full mt-1 border border-gray-300 p-2 rounded" id="zoneType" required="">
        <option value="">
         -- Select Zone Type --
        </option>
        <option value="3pt">
         3pt
        </option>
        <option value="midrange">
         Midrange
        </option>
       </select>
      </div>
     </div>
     <!-- Zone Inputs -->
     <div class="mt-6 space-y-4" id="zoneInputs">
     </div>
     <!-- Notes -->
     <div>
      <label class="block text-sm font-medium text-gray-700 flex items-center gap-1" for="notes">
       <!-- Pencil icon -->
       <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="1.5" viewbox="0 0 24 24">
        <path d="M15.232 5.232l3.536 3.536M9 11l6-6m2.121-2.121a3 3 0 114.243 4.243L9 21H3v-6l12.121-12.121z" stroke-linecap="round" stroke-linejoin="round">
        </path>
       </svg>
       Notes
      </label>
      <textarea class="w-full mt-1 border border-gray-300 p-2 rounded" id="notes" rows="3"></textarea>
     </div>
     <!-- Submit -->
     <button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-medium flex items-center justify-center gap-2" type="submit">
      <span class="text-lg">
       ğŸ€
      </span>
      <span>
       Submit Session
      </span>
     </button>
    </form>
   </div>
   <!-- ğŸ“‹ Training Session Log (Table) -->
   <div class="bg-white p-6 rounded-xl shadow-md flex flex-col w-full">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
       ğŸ“‹ Training Session Log
      </h2>
      <button id="exportCsvBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
  ğŸ“¤ Export to CSV
</button>
    </div>
    <div class="overflow-x-auto w-full">
     <table class="min-w-full w-full text-sm text-left border border-gray-300">
      <thead class="bg-gray-100 text-xs uppercase font-bold">
       <tr>
        <th data-sort="date" class="cursor-pointer">ğŸ“… Date <span class="sort-indicator"></span></th>
        <th data-sort="date" class="cursor-pointer">
         ğŸ€ Type
        <span class="sort-indicator"></span></th>
        <th data-sort="date" class="cursor-pointer">
         ğŸ“ Zones
        <span class="sort-indicator"></span></th>
        <th class="px-4 py-2">
         ğŸ” Rounds
        </th>
        <th data-sort="date" class="cursor-pointer">
         ğŸ¯ Accuracy
        <span class="sort-indicator"></span></th>
        <th class="px-4 py-2">
         ğŸ“ Notes
        </th>
        <th class="px-4 py-2">
         âš™ï¸ Actions
        </th>
       </tr>
      </thead>
      <tbody class="divide-y divide-gray-200 bg-white" id="sessionTableBody">
       <!-- table rows injected here -->
      </tbody>
     </table>

    </div>
   </div>
   <!-- ğŸ“Š Right: SmartShooter Training Log (Chart + Filters) -->
   <div class="bg-white p-6 rounded-xl shadow-md flex flex-col w-full">
    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
     ğŸ“Š SmartShooter Training Log
    </h2>
    <!-- Accuracy Over Time Chart -->
    <div class="flex-1">
     <canvas class="w-full h-full" id="progressChart">
     </canvas>
    </div>
    <!-- Filters -->
    <div class="mt-6 flex flex-col md:flex-row gap-6 items-start">
     <!-- Filter Shot Zones by Session -->
     <div class="flex-1 bg-white p-4 rounded-lg shadow flex flex-col">
      <h3 class="text-base font-semibold mb-3 flex items-center gap-2">
       ğŸ¯ Filter Shot Zones by Session
      </h3>
      <div class="space-y-1 text-sm" id="sessionCheckboxList">
      </div>
      <button class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 w-full md:w-auto" id="applyZoneFilter">
       Filter Zones
      </button>
     </div>
     <!-- Filter Accuracy Chart -->
     <div class="flex-1 bg-white p-4 rounded-lg shadow flex flex-col">
      <h3 class="text-base font-semibold mb-3 flex items-center gap-2">
       ğŸ¯ Filter Shooting Accuracy Chart
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
       <!-- Training Type -->
       <div>
        <label class="text-sm font-medium text-gray-700 flex items-center gap-1 mb-1" for="trainingTypeFilter">
         ğŸ—‚ï¸
                Training Type
        </label>
        <select class="w-full border border-gray-300 p-2 rounded" id="trainingTypeFilter" multiple="">
         <option value="Spot Shooting">
          Spot Shooting
         </option>
         <option value="Catch and Shoot">
          Catch and Shoot
         </option>
         <option value="Off the Dribble">
          Off the Dribble
         </option>
         <option value="Run Half Court">
          Run Half Court
         </option>
        </select>
       </div>
       <!-- Zone Type -->
       <div>
        <label class="text-sm font-medium text-gray-700 flex items-center gap-1 mb-1" for="zoneTypeFilter">
         ğŸ“ Zone
                Type
        </label>
        <select class="w-full border border-gray-300 p-2 rounded" id="zoneTypeFilter" multiple="">
         <option value="3pt">
          3pt
         </option>
         <option value="midrange">
          midrange
         </option>
        </select>
       </div>
      </div>
      <button class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 w-full md:w-auto" id="applyChartFilter">
       Apply Filters
      </button>
     </div>
    </div>
   </div>
   <!-- ğŸ”¥ Right: Hot Zones Chart -->
   <div class="bg-white p-6 rounded-xl shadow-md flex flex-col w-full">
    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
     ğŸ”¥ Hot Zones
    </h2>
    <div class="flex-1 flex justify-center items-center overflow-x-auto">
     <div class="relative w-full max-w-[600px] aspect-[3/2]" id="zoneChart">
      <!-- Shot zone chart image and overlays -->
     </div>
    </div>
   </div>
  </div>
  <!-- âœï¸ Edit Modal -->
  <div class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50" id="editModal">
   <div class="bg-white rounded-lg w-full max-w-3xl p-6 shadow-lg relative">
    <h2 class="text-xl font-semibold mb-4">
     âœï¸ Edit Training Session
    </h2>
    <form class="space-y-4" id="editForm">
     <input id="editSessionId" type="hidden"/>
     <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
       <label class="block text-sm font-medium text-gray-700" for="editDate">
        Date
       </label>
       <input class="w-full mt-1 border border-gray-300 p-2 rounded" id="editDate" required="" type="date"/>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700" for="editTrainingType">
        Training Type
       </label>
       <select class="w-full mt-1 border border-gray-300 p-2 rounded" id="editTrainingType" required="">
        <option value="">
         -- Select Training Type --
        </option>
        <option value="Spot Shooting">
         Spot Shooting
        </option>
        <option value="Catch and Shoot">
         Catch and Shoot
        </option>
        <option value="Off the Dribble">
         Off the Dribble
        </option>
        <option value="Run Half Court">
         Run Half Court
        </option>
       </select>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700" for="editZoneType">
        Zone Type
       </label>
       <select class="w-full mt-1 border border-gray-300 p-2 rounded" id="editZoneType" required="">
        <option value="">
         -- Select Zone Type --
        </option>
        <option value="3pt">
         3pt
        </option>
        <option value="midrange">
         Midrange
        </option>
       </select>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700" for="editRoundCount">
        Rounds
       </label>
       <input class="w-full mt-1 border border-gray-300 p-2 rounded" id="editRoundCount" max="10" min="1" required="" type="number" value="1"/>
      </div>
     </div>
     <div class="space-y-4" id="editZoneInputs">
     </div>
     <div>
      <label class="block text-sm font-medium text-gray-700" for="editNotes">
       Notes
      </label>
      <textarea class="w-full mt-1 border border-gray-300 p-2 rounded" id="editNotes" rows="3"></textarea>
     </div>
     <div class="flex justify-end gap-4 pt-2">
      <button class="bg-gray-300 text-gray-800 py-2 px-4 rounded hover:bg-gray-400" id="cancelEdit" type="button">
       Cancel
      </button>
      <button class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 flex items-center gap-2" type="submit">
       <span class="text-lg">
        âœï¸
       </span>
       <span>
        Update Session
       </span>
      </button>
     </div>
    </form>
   </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js">
  </script>
  <script src="https://cdn.jsdelivr.net/npm/konva@9/konva.min.js">
  </script>
  <script src="./firebase-setup.js" type="module">
  </script>
  <script src="./session-handler.js" type="module">
  </script>
  <!-- <script type="module" src="./session-handler-debug.js"></script> -->
  <script src="./progress-chart.js" type="module">
  </script>
  <script src="./ui-render.js" type="module">
  </script>
  <script>
   const zoneMap = {
      "3pt": ["Left Corner", "Left Wing 3pt", "Top of Key 3pt", "Right Wing 3pt", "Right Corner"],
      "midrange": ["Left Baseline", "Left Wing", "Free Throw", "Right Wing", "Right Baseline"]
    };

    function renderZoneRounds(containerId, zoneNames, roundCount = 1, prefix = '') {
      const container = document.getElementById(containerId);
      container.innerHTML = '';

      for (let round = 1; round <= roundCount; round++) {
        const roundHeader = document.createElement('h4');
        roundHeader.className = "text-sm font-semibold text-blue-700 mt-4";
        roundHeader.textContent = `Round ${round}`;
        container.appendChild(roundHeader);

        const headerRow = document.createElement('div');
        headerRow.className = "grid grid-cols-5 gap-4";
        zoneNames.forEach(zone => {
          const div = document.createElement('div');
          div.className = "text-center font-semibold text-xs";
          div.textContent = zone;
          headerRow.appendChild(div);
        });

        const attemptRow = document.createElement('div');
        attemptRow.className = "grid grid-cols-5 gap-4";
        const attemptInputs = {};

        zoneNames.forEach(zone => {
          const input = document.createElement('input');
          input.type = 'number';
          input.name = `${prefix}round_${round}_attempted_${zone}`;
          input.placeholder = 'Attempted';
          input.min = 0;
          input.className = 'p-2 border rounded text-center text-xs';
          attemptInputs[zone] = input;
          attemptRow.appendChild(input);
        });

        const madeRow = document.createElement('div');
        madeRow.className = "grid grid-cols-5 gap-4";

        zoneNames.forEach(zone => {
          const input = document.createElement('input');
          input.type = 'number';
          input.name = `${prefix}round_${round}_made_${zone}`;
          input.placeholder = 'Made';
          input.min = 0;
          input.className = 'p-2 border rounded text-center text-xs';

          input.addEventListener("input", () => {
            const attempted = parseInt(attemptInputs[zone].value || 0);
            const made = parseInt(input.value || 0);
            if (made > attempted) {
              input.value = attempted;
            }
          });

          madeRow.appendChild(input);
        });

        container.appendChild(headerRow);
        container.appendChild(attemptRow);
        container.appendChild(madeRow);
      }
    }


    function triggerRenderZoneInputs(prefix = '', containerId = 'zoneInputs', zoneTypeId = 'zoneType', roundCountId = 'roundCount') {
      const zoneType = document.getElementById(zoneTypeId)?.value;
      const roundCount = parseInt(document.getElementById(roundCountId)?.value || 1);
      const zoneNames = zoneMap[zoneType] || [];
      renderZoneRounds(containerId, zoneNames, roundCount, prefix);
    }

    document.addEventListener("DOMContentLoaded", () => {
      // New session form
      document.getElementById("zoneType")?.addEventListener("change", () => {
        triggerRenderZoneInputs();
      });

      document.getElementById("roundCount")?.addEventListener("input", () => {
        triggerRenderZoneInputs();
      });

      // Edit session modal
      document.getElementById("editZoneType")?.addEventListener("change", () => {
        triggerRenderZoneInputs('edit_', 'editZoneInputs', 'editZoneType', 'editRoundCount');
      });

      document.getElementById("editRoundCount")?.addEventListener("input", () => {
        triggerRenderZoneInputs('edit_', 'editZoneInputs', 'editZoneType', 'editRoundCount');
      });
    });
  </script>
  <script type="module">
   import { renderZonesChart } from './ui-render.js';

    window.addEventListener("DOMContentLoaded", () => {
      const container = document.getElementById("sessionCheckboxList");
      const btn = document.getElementById("applyZoneFilter");

      function updateCheckboxList(sessions) {
        container.innerHTML = "";
        sessions.forEach(s => {
          const box = document.createElement("div");
          box.innerHTML = `
          <label><input type="checkbox" class="zone-filter" value="${s.id}" checked />
          ${s.date} â€“ ${s.trainingType}</label>`;
          container.appendChild(box);
        });
      }

      btn.addEventListener("click", () => {
        const selectedIds = Array.from(document.querySelectorAll(".zone-filter:checked")).map(cb => cb.value);
        const selectedSessions = window.allSessions.filter(s => selectedIds.includes(s.id));
        renderZonesChart(selectedSessions);
      });

      setTimeout(() => {
        if (window.allSessions) updateCheckboxList(window.allSessions);
      }, 1000);
    });
  </script>
  <!-- ğŸ“Š Filter Accuracy Chart -->
  <script type="module">
   import { renderProgressChartFromSessions } from './progress-chart.js';
    import { renderZonesChart } from './ui-render.js';


    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("applyChartFilter")?.addEventListener("click", () => {
        const training = Array.from(document.getElementById("trainingTypeFilter")?.selectedOptions || []).map(opt => opt.value);
        const zones = Array.from(document.getElementById("zoneTypeFilter")?.selectedOptions || []).map(opt => opt.value);

        const filtered = (window.allSessions || []).filter(s =>
          (training.length === 0 || training.includes(s.trainingType)) &&
          (zones.length === 0 || zones.includes(s.zoneType))
        );

        renderProgressChartFromSessions(filtered);
        renderZonesChart(filtered);

      });
    });
  </script>
 </body>
</html>
